#!/usr/bin/env bash

username=
password=
domain=

base_dir="$( cd "$( dirname "$0" )" && pwd )"
code_server_version="4.89.1"
code_server_folder_name="code-server-$code_server_version-linux-amd64"
code_server_tarball_name="$code_server_folder_name.tar.gz"

die() {
    printf '%s\n' "$1" >&2
    exit 1
}

show_help() {
    printf 'Correct Usage: ./install -u [new-username] -p [access-password] -d [domain]\n'
    exit 1
}

validate_input() {
    while :; do
        case $1 in
            -h|--help)
                show_help
                exit
                ;;
            -u)
                if [ "$2" ]; then
                    username=$2
                    shift
                else
                    die 'ERROR: "-u" requires a non-empty option argument.'
                fi
                ;;
            -p)
                if [ "$2" ]; then
                    password=$2
                    shift
                else
                    die 'ERROR: "-p" requires a non-empty option argument.'
                fi
                ;;
            -d)
                if [ "$2" ]; then
                    domain=$2
                    shift
                else
                    die 'ERROR: "-d" requires a non-empty option argument.'
                fi
                ;;
            --)
                shift
                break
                ;;
            -?*)
                printf 'WARN: Unknown option: %s\n' "$1" >&2
                show_help
                exit
                ;;
            *)
                break
        esac
        shift
    done

    if [[ -z "$username" ]]; then
        printf 'ERROR: "-u" is a required argument.\n'
        show_help
        exit
    fi

    if [[ -z "$password" ]]; then
        printf 'ERROR: "-p" is a required argument.\n'
        show_help
        exit
    fi

    if [[ -z "$domain" ]]; then
        printf 'ERROR: "-d" is a required argument.\n'
        show_help
        exit
    fi
}

create_user_if_not_exists() {
    if id "$username" >/dev/null 2>&1; then
        printf 'user already exists\n'
    else
        adduser "$username"
        printf 'user %s created\n' "$username"
    fi
}

add_user_to_sudo_if_not_already_present() {
    if id -nG "$username" | grep -qw sudo; then
        printf 'user already belongs to sudo\n'
    else
        usermod -aG sudo "$username"
        printf 'user %s added to sudo\n' "$username"
    fi
}

setup_non_root_user() {
    create_user_if_not_exists
    add_user_to_sudo_if_not_already_present

    if id -nG "$username" | grep -qw sudo; then
        printf 'user is successfully setup\n'
    else
        die 'ERROR: unable to setup the non root user'
    fi
}

setup_ssh_if_not_done_previously() {
    user_ssh_directory=/home/"$username"/.ssh
    if [ ! -d "$user_ssh_directory" ]; then
        rsync --archive --chown="$username":"$username" ~/.ssh /home/"$username"
        printf 'user ssh setup finished\n'
    fi
}

download_and_unpack_code_server() {
    mkdir -p /tmp/code-server
    cd /tmp/code-server
    if [ ! -f $code_server_tarball_name ]; then
        wget https://github.com/coder/code-server/releases/download/v$code_server_version/$code_server_tarball_name
        printf "code server tarball downloaded\n"
    fi
    tar -xzvf $code_server_tarball_name
    printf "code server tarball unpacked\n"
}

copy_and_symlink_code_server() {
    sudo cp -r $code_server_folder_name /usr/lib/code-server
    sudo ln -sf /usr/lib/code-server/bin/code-server /usr/bin/code-server
    printf "code server setup finished\n"
}

create_user_data_dir_for_code_server() {
    sudo mkdir -p /var/lib/code-server
}

delete_code_server_installation_files() {
    rm -rf /tmp/code-server/$code_server_folder_name
}

setup_systemd_service_for_code_server() {
    target="${base_dir}/tmp.txt"
    code_server_service_file="`cat ${base_dir}/code-server.service`"

    printf "$code_server_service_file" "$password" "$username" > $target
}

uninstall_code_server() {
    # Delete code-server.service
    sudo systemctl stop code-server
    rm /usr/bin/code-server
    rm -rf /usr/lib/code-server
}

delete_code_server_installer_including_downloaded_tarball() {
    rm -rf /tmp/code-server/
}

validate_input "$@"

setup_non_root_user
setup_ssh_if_not_done_previously

download_and_unpack_code_server
copy_and_symlink_code_server
create_user_data_dir_for_code_server
delete_code_server_installation_files
setup_systemd_service_for_code_server

printf 'success %s %s %s\n' "$username" "$password" "$domain"
